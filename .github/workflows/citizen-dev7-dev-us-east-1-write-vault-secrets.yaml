name: Write Vault Secrets

on:
  workflow_dispatch:
    inputs:
      vault_path:
        description: 'Full Vault path where secrets will be written (e.g., kvv2/22391/cursorpm/data/my-secret)'
        type: string
        required: true
      secrets_json:
        description: 'JSON object with key-value pairs to write (e.g., {"KEY1": "value1", "KEY2": "value2"})'
        type: string
        required: true
      environment:
        description: 'Environment name to load vault variables from (e.g., cursor-pm-dev-us-east-1)'
        type: string
        required: true

jobs:
  write-secrets:
    name: Write Secrets to Vault
    runs-on: gh-larger-linux-arm64-mini
    environment: ${{ inputs.environment }}
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Load environment variables
        run: |
          echo "VAULT_ADDR: ${{ vars.VAULT_ADDR }}"
          echo "VAULT_MOUNT_PATH: ${{ vars.VAULT_MOUNT_PATH }}"
          echo "VAULT_GHA_AUTH_ROLE: ${{ vars.VAULT_GHA_AUTH_ROLE }}"
          echo "GH_ORG_NAME: ${{ vars.GH_ORG_NAME }}"

      - name: Install Vault
        run: |
          vault_version="1.19.2"
          curl -Lo vault.zip https://releases.hashicorp.com/vault/${vault_version}/vault_${vault_version}_linux_arm64.zip
          unzip vault.zip
          chmod u+x vault
          mv vault "/usr/local/bin/vault"
          rm vault.zip
          vault version

      - name: Generate agentless Vault URL
        id: gha-vault-access-url
        shell: bash
        run: |
          VAULT_GHA_URL=$(echo "${{ vars.VAULT_ADDR }}" | sed 's/com/cloud/g')
          echo "VAULT_GHA_URL=${VAULT_GHA_URL}" >> $GITHUB_OUTPUT
          echo "Vault URL for GitHub action: ${VAULT_GHA_URL}"

      - name: Authenticate to Vault
        id: vault-auth
        uses: hashicorp/vault-action@v3.3.0
        with:
          url: ${{ steps.gha-vault-access-url.outputs.VAULT_GHA_URL }}
          role: ${{ vars.VAULT_GHA_AUTH_ROLE }}
          method: jwt
          path: ghajwt/${{ vars.VAULT_MOUNT_PATH }}
          jwtGithubAudience: https://github.com/${{ vars.GH_ORG_NAME }}
          exportEnv: true
          exportToken: true
          extraHeaders: |
            CF-Access-Client-Id: ${{ secrets.GHA_U2A_CF_ACCESS_CLIENT_ID }}
            CF-Access-Client-Secret: ${{ secrets.GHA_U2A_CF_ACCESS_CLIENT_SECRET }}
          secrets: |
            ${{ vars.VAULT_MOUNT_PATH }}/data/vvm/approle-credentials/rw/rw secret_id | VAULT_SECRET_ID;
            ${{ vars.VAULT_MOUNT_PATH }}/data/vvm/approle-credentials/rw/rw role_id | VAULT_ROLE_ID;

      - name: Parse and validate secrets JSON
        id: parse-secrets
        env:
          SECRETS_JSON: ${{ inputs.secrets_json }}
        shell: bash
        run: |
          # Validate JSON format
          echo "${SECRETS_JSON}" | jq empty || (echo "Invalid JSON format" && exit 1)
          
          # Display what will be written (without values for security)
          echo "Secrets to write to path: ${{ inputs.vault_path }}"
          echo "${SECRETS_JSON}" | jq -r 'keys[]' | while read key; do
            echo "  - ${key}"
          done

      - name: Write secrets to Vault
        uses: hashicorp/vault-action@v3.3.0
        env:
          SECRETS_JSON: ${{ inputs.secrets_json }}
          VAULT_PATH: ${{ inputs.vault_path }}
        with:
          url: ${{ steps.gha-vault-access-url.outputs.VAULT_GHA_URL }}
          method: token
          token: ${{ env.VAULT_TOKEN }}
          exportEnv: true
          exportToken: true
          extraHeaders: |
            CF-Access-Client-Id: ${{ secrets.GHA_U2A_CF_ACCESS_CLIENT_ID }}
            CF-Access-Client-Secret: ${{ secrets.GHA_U2A_CF_ACCESS_CLIENT_SECRET }}
        continue-on-error: false

      - name: Execute vault kv put command
        env:
          VAULT_TOKEN: ${{ env.VAULT_TOKEN }}
          VAULT_ADDR: ${{ steps.gha-vault-access-url.outputs.VAULT_GHA_URL }}
          SECRETS_JSON: ${{ inputs.secrets_json }}
          VAULT_PATH: ${{ inputs.vault_path }}
          GHA_U2A_CF_ACCESS_CLIENT_ID: ${{ secrets.GHA_U2A_CF_ACCESS_CLIENT_ID }}
          GHA_U2A_CF_ACCESS_CLIENT_SECRET: ${{ secrets.GHA_U2A_CF_ACCESS_CLIENT_SECRET }}
        shell: bash
        run: |
          # Cloudflare Access headers
          export VAULT_HEADERS="$(cat <<JSON
          {
            "CF-Access-Client-Id": "${GHA_U2A_CF_ACCESS_CLIENT_ID}",
            "CF-Access-Client-Secret": "${GHA_U2A_CF_ACCESS_CLIENT_SECRET}"
          }
          JSON
          )"
          
          # Build command with all key-value pairs
          set +H  # Disable history expansion to avoid issues with !
          CMD_ARGS=()
          while IFS=$'\t' read -r key value; do
            CMD_ARGS+=("${key}=${value}")
          done < <(echo "${SECRETS_JSON}" | jq -r 'to_entries[] | "\(.key)\t\(.value)"')
          
          # Execute vault kv put with all secrets
          vault kv put "${VAULT_PATH}" "${CMD_ARGS[@]}" || {
            echo "Failed to write secrets to ${VAULT_PATH}"
            exit 1
          }
          
          echo "Successfully wrote all secrets to ${VAULT_PATH}"
