###############################################################################
# ---------------------- DO NOT EDIT THIS FILE !!!-----------------------------
#
# This file is generated by Deployer K8s PaaS ControlPlane.
# Any changes to this file can be overwritten at any time by the ControlPlane.
#
###############################################################################
name: citizen-dev7-dev-us-Rotate DB secrets

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * 6'  # Every Saturday at 00:00 UTC

jobs:
  load-environment-vars:
    name: environment-context
    runs-on: [gh-larger-linux-mini]
    environment: citizen-dev7-dev-us-east-1
    outputs:
      GH_ORG_NAME: ${{ vars.GH_ORG_NAME }}
      TFE_ORG: ${{ vars.TF_ORG }}
      TF_WORKSPACE: ${{ vars.TF_WORKSPACE }}
      CLUSTER_LOGIN_URL: ${{ vars.KUBERNETES_CLUSTER_LOGIN_URL }}
      KUBERNETES_NAMESPACE_NAME: ${{ vars.KUBERNETES_NAMESPACE_NAME }}
      VAULT_BACKEND_INSTANCE_ID: ${{ vars.VAULT_BACKEND_INSTANCE_ID }}
      VAULT_MOUNT_PATH: ${{ vars.VAULT_MOUNT_PATH }}
      VAULT_ADDR: ${{ vars.VAULT_ADDR }}
      VAULT_GHA_AUTH_ROLE: ${{ vars.VAULT_GHA_AUTH_ROLE }}

    steps:
      - name: Run
        id: setup-env
        run: |
          echo "Setup environment specific variables and secrets"
          echo "GH_ORG_NAME: ${{ vars.GH_ORG_NAME }}"
          echo "TF_ORG: ${{ vars.TF_ORG }}"
          echo "TF_WORKSPACE: ${{ vars.TF_WORKSPACE }}"
          echo "CLUSTER_LOGIN_URL: ${{ vars.KUBERNETES_CLUSTER_LOGIN_URL}}"
          echo "KUBERNETES_NAMESPACE_NAME: ${{ vars.KUBERNETES_NAMESPACE_NAME }}"
          echo "VAULT_BACKEND_INSTANCE_ID: ${{ vars.VAULT_BACKEND_INSTANCE_ID }}"
          echo "VAULT_MOUNT_PATH: ${{ vars.VAULT_MOUNT_PATH }}"
          echo "VAULT_URL: ${{ vars.VAULT_ADDR }}"
          echo "VAULT_GHA_AUTH_ROLE: ${{ vars.VAULT_GHA_AUTH_ROLE }}"

  rotate-db-secret:
    name: Rotate DB Secret
    needs: [load-environment-vars]
    uses: McK-Internal/lrah-control-plane/.github/workflows/lrah-reusable-rotate-db-secrets.yaml@main
    with:
      environment: citizen-dev7-dev-us-east-1
      TF_ORG: ${{ needs.load-environment-vars.outputs.TFE_ORG }}
      TF_WORKSPACE: ${{ needs.load-environment-vars.outputs.TF_WORKSPACE }}
    secrets: inherit

  deploy-infra-secrets:
    name: Infrastructure secrets
    needs: [load-environment-vars, rotate-db-secret]
    uses: McK-Internal/lrah-control-plane/.github/workflows/lrah-reusable-deploy-infra-secrets.yaml@v1.21.0
    with:
      environment: citizen-dev7-dev-us-east-1
      cluster_login_url: ${{ needs.load-environment-vars.outputs.CLUSTER_LOGIN_URL }}
      kubernetes_namespace_name: ${{ needs.load-environment-vars.outputs.KUBERNETES_NAMESPACE_NAME }}
      vault_instance_id: ${{ needs.load-environment-vars.outputs.VAULT_BACKEND_INSTANCE_ID }}
      vault_mount_path: ${{ needs.load-environment-vars.outputs.VAULT_MOUNT_PATH }}
      vault_url: ${{ needs.load-environment-vars.outputs.VAULT_ADDR }}
      vault_gha_auth_role: ${{ needs.load-environment-vars.outputs.VAULT_GHA_AUTH_ROLE }}
      github_org_name: ${{ needs.load-environment-vars.outputs.GH_ORG_NAME }}
    secrets: inherit
